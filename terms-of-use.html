<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cutters Choice Radio — Schedule</title>

  <!-- Site CSS + Fonts -->
  <link rel="stylesheet" href="style.css?v=1754655398070" />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- NAV styling copied from index.html for a perfect match -->
  <style>
    :root {
      --brand-teal: #5A8785;

      /* schedule layout scale */
      --hourH: 52px;         /* height per hour (taller makes blocks bigger) */
      --qH: calc(var(--hourH) / 4); /* quarter-hour track */
    }

    /* NAVIGATION BAR */
    #main-nav {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      width: 100% !important;
      padding: 0.10rem 0.65rem !important;
      margin: 0 !important;
      box-sizing: border-box !important;
      background-color: var(--brand-teal) !important;
      position: relative !important;
      z-index: 1000 !important;
    }
    #main-nav .nav-item { flex: 1 !important; }
    #main-nav .nav-left { text-align: left !important; }
    #main-nav .nav-center { text-align: center !important; }
    #main-nav .nav-right {
      display: flex !important;
      align-items: center !important;
      justify-content: flex-end !important;
      flex: 1 !important;
    }
    #main-nav a.nav-link {
      color: #fff !important;
      font-family: 'Bebas Neue', sans-serif !important;
      font-size: 2rem !important;
      text-transform: uppercase !important;
      text-decoration: none !important;
      margin: 0 0.5rem !important;
    }
    #main-nav .social-icon,
    #main-nav .icon-img {
      margin-left: 0.5rem !important;
      vertical-align: middle !important;
      width: 2rem !important;
      height: auto !important;
    }
    #manualCastBtn {
      background: none; border: none; color: #fff; font-size: 1.8rem; cursor: pointer; margin-left: 0.5rem;
    }
    @media (max-width: 768px) {
      #main-nav { flex-wrap: nowrap !important; padding: 0.115rem 0.5rem !important; }
      #main-nav .nav-item { text-align: center !important; flex: 1 !important; }
      #main-nav a.nav-link { font-size: 1rem !important; margin: 0 0.25rem !important; }
      #main-nav .social-icon, #main-nav .icon-img, #main-nav .nav-onemusic { display: none !important; }
    }

    /* PAGE-SPECIFIC STYLES */
    html, body { background:#000; color:#fafafa; }
    * { box-sizing: border-box; }

    .page-header {
      display:flex; align-items:center; justify-content:space-between;
      padding:.5rem .75rem; border-bottom:2px solid #000; background: var(--brand-teal);
    }
    .page-header h1 {
      font-family:'Bebas Neue',sans-serif; font-size:2.2rem; letter-spacing:.5px; color:#fff; margin:0;
    }
    .utilities { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
    .legend { display:flex; gap:.5rem; align-items:center; }
    .chip { width:.9rem; height:.9rem; border-radius:2px; border:1px solid #1f1f1f; display:inline-block; }

    .month-controls {
      display:flex; gap:.5rem; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--brand-teal); padding:.75rem .75rem; position:sticky; top:0; background:#000; z-index:20;
    }
    .month-controls .title { font-family:'Bebas Neue',sans-serif; font-size:2rem; color:var(--brand-teal); }
    .ccr-btn {
      background: var(--brand-teal); color:#fff; border:none; border-radius:6px; padding:.5rem .75rem; cursor:pointer;
      font-weight:600; letter-spacing:.3px;
    }

    .weeks-stack { display:flex; flex-direction:column; gap:1.25rem; padding:1rem .75rem 2rem; }

    /* 8 columns: time ruler + 7 days */
    .week-grid {
      display:grid;
      grid-template-columns: 64px repeat(7, 1fr);
      gap: 6px;
      border:2px solid var(--brand-teal);
      border-radius:8px;
      overflow:hidden;
      background:#0f0f0f;
      padding: 6px;
    }

    /* Time ruler column */
    .time-col {
      position: relative;
      height: calc(var(--hourH) * 24);
      border:1px solid #1c1c1c; border-radius:6px;
      background:
        repeating-linear-gradient(
          to bottom,
          #0b0b0b 0,
          #0b0b0b calc(var(--hourH) - 1px),
          #1e1e1e calc(var(--hourH) - 1px),
          #1e1e1e var(--hourH)
        );
    }
    .time-col .hour-label {
      position: absolute; left: 6px; font-size:.78rem; color:#a7a7a7;
      transform: translateY(-50%);
    }

    /* Day column header + body */
    .day-col { display:flex; flex-direction:column; }
    .day-head { background:#0d0d0d; border:1px solid #1e1e1e; padding:.45rem .5rem; border-radius:6px; margin-bottom:6px; }
    .dow { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; color:var(--brand-teal); }
    .date { font-size:.85rem; color:#bdbdbd; }

    .day-body {
      display: grid;
      grid-template-rows: repeat(96, var(--qH)); /* 96 x 15min rows */
      position: relative;
      height: calc(var(--hourH) * 24);
      border:1px solid #1c1c1c; border-radius:6px; overflow:hidden;
      background:
        repeating-linear-gradient(
          to bottom,
          #0b0b0b 0,
          #0b0b0b calc(var(--hourH) - 1px),
          #1a1a1a calc(var(--hourH) - 1px),
          #1a1a1a var(--hourH)
        );
    }

    /* Show block placed on the grid (no absolute top/height -> perfect alignment) */
    .show {
      grid-column: 1 / -1;
      margin: 2px 4px;
      border-left:8px solid var(--chip, #22d3ee);
      background: var(--bg, #11212e);
      border-radius:6px; padding:.35rem .5rem; overflow:hidden;
      box-shadow: 0 1px 0 rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .show .time { font-size:.78rem; color:#e5e5e5; }
    .show .title { font-weight:800; color:#fff; line-height:1.2; }
    .show .host { font-size:.85rem; color:#d1d1d1; }

    /* Brighter palette */
    .tone-1 { --chip:#22D3EE; --bg:#083344; } /* cyan */
    .tone-2 { --chip:#34D399; --bg:#062f25; } /* green */
    .tone-3 { --chip:#F59E0B; --bg:#261a03; } /* amber */
    .tone-4 { --chip:#F97316; --bg:#2a1304; } /* orange */
    .tone-5 { --chip:#A78BFA; --bg:#1c1630; } /* violet */
    .tone-6 { --chip:#EC4899; --bg:#2b0f20; } /* pink */
    .tone-7 { --chip:#4ADE80; --bg:#0f2714; } /* light green */
    .tone-8 { --chip:#60A5FA; --bg:#0a1a35; } /* light blue */

    /* Archives = BLUE, always */
    .is-archive { --chip:#3B82F6; --bg:#0b1f3f; }

    @media (max-width: 980px) {
      .week-grid { grid-template-columns: 48px 1fr; }
      .day-col { grid-column: 2; }
      .time-col { grid-column: 1; }
    }
  </style>

  <!-- Chromecast init (kept) -->
  <script>
    window.__onGCastApiAvailable = isAvailable => {
      if (isAvailable) {
        cast.framework.CastContext.getInstance().setOptions({
          receiverApplicationId: '77E0F81B',
          autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
        });
      }
    };
  </script>
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</head>

<body>
  <!-- NAV -->
  <nav id="main-nav">
    <div class="nav-item nav-left">
      <a href="our-story.html" class="nav-link">OUR STORY</a>
    </div>
    <div class="nav-item nav-center">
      <a href="index-ourDJS.html" class="nav-link">OUR DJS</a>
    </div>
    <div class="nav-item nav-right">
      <a href="schedule.html" class="nav-link">SCHEDULE</a>
      <a href="merch.html" class="nav-link">MERCH</a>

      <a href="https://facebook.com/cutterschoiceradio" target="_blank" class="social-icon">
        <i class="fab fa-facebook-f"></i>
      </a>
      <a href="https://instagram.com/cutterschoiceradio" target="_blank" class="social-icon">
        <i class="fab fa-instagram"></i>
      </a>

      <img src="/images/alexa-logo.webp" alt="Alexa" class="icon-img" loading="lazy">
      <a href="https://tunein.com/radio/Cutters-Choice-Radio-s344746/" target="_blank">
        <img src="/images/tunein-logo.png" alt="TuneIn" class="icon-img" loading="lazy">
      </a>

      <div class="nav-onemusic">
        <a href="https://onemusicnz.com" target="_blank" rel="noopener">
          <img src="/images/ONEMUSICLOGO.png" alt="We’re licensed to play OneMusic NZ" loading="lazy">
        </a>
      </div>

      <google-cast-button></google-cast-button>
      <button id="manualCastBtn" title="Cast this stream">
        <i class="fab fa-chromecast"></i>
      </button>
    </div>
  </nav>

  <header class="page-header">
    <h1>Monthly Schedule</h1>
    <div class="utilities">
      <button class="ccr-btn" id="todayBtn" title="Jump to current week">This Week</button>
      <div class="legend">
        <span class="chip" style="background:#22D3EE"></span>
        <span class="chip" style="background:#34D399"></span>
        <span class="chip" style="background:#F59E0B"></span>
        <span class="chip" style="background:#F97316"></span>
        <span class="chip" style="background:#A78BFA"></span>
        <span class="chip" style="background:#EC4899"></span>
        <span class="chip" style="background:#4ADE80"></span>
        <span class="chip" style="background:#60A5FA"></span>
        <small style="opacity:.8;">Order of shows each day</small>
        <span class="chip" style="background:#3B82F6;margin-left:.5rem;"></span>
        <small style="opacity:.8;">Archives</small>
      </div>
    </div>
  </header>

  <section class="month-controls">
    <div>
      <button class="ccr-btn" id="prevMonthBtn" aria-label="Previous month">◀</button>
      <button class="ccr-btn" id="nextMonthBtn" aria-label="Next month">▶</button>
    </div>
    <div class="title" id="monthTitle">Loading…</div>
    <div>
      <label style="display:flex;align-items:center;gap:.35rem;">
        <span style="font-size:.9rem;color:#bdbdbd;">Times in</span>
        <select id="tzSelect" class="ccr-btn" style="background:#0a0a0a;border:1px solid #1c1c1c;color:#fff;">
          <option value="local">Your local time</option>
          <option value="Europe/London">UK (Europe/London)</option>
          <option value="UTC">UTC</option>
        </select>
      </label>
    </div>
  </section>

  <main class="weeks-stack" id="weeksStack" aria-live="polite">
    <p style="opacity:.7;">Fetching month…</p>
  </main>

  <footer class="banner">
    <a href="privacy-policy.html">PRIVACY POLICY</a>
    <a href="index.html">Back to Home</a>
  </footer>

  <script>
    // ==== API (same auth style as homepage) ====
    const API_KEY = "pk_0b8abc6f834b444f949f727e88a728e0";
    const STATION_ID = "cutters-choice-radio";
    const BASE_URL = "https://api.radiocult.fm/api";
    const rcFetch = async (path) => {
      const res = await fetch(BASE_URL + path, { headers: { "x-api-key": API_KEY } });
      if (!res.ok) throw new Error(`Fetch error ${res.status}`);
      return res.json();
    };

    // ==== DATE HELPERS ====
    const pad = n => String(n).padStart(2,"0");
    const fmtMonth = d => new Intl.DateTimeFormat(undefined,{month:"long",year:"numeric"}).format(d);
    const startOfWeek = (date) => {
      const d = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
      const day = (d.getUTCDay() + 6) % 7; // Monday=0
      d.setUTCDate(d.getUTCDate() - day);
      return d;
    };
    const endOfWeek = (date) => { const d = new Date(date); d.setUTCDate(d.getUTCDate()+6); d.setUTCHours(23,59,59,999); return d; };
    const startOfMonth = (date) => new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), 1));
    const endOfMonth = (date) => new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth()+1, 0, 23,59,59,999));
    const splitMonthIntoWeeks = (anyDay) => {
      const weeks = [];
      let wStart = startOfWeek(startOfMonth(anyDay));
      const lastDay = endOfWeek(endOfMonth(anyDay));
      while (wStart <= lastDay) {
        const wEnd = endOfWeek(wStart);
        weeks.push({ start: new Date(wStart), end: new Date(wEnd) });
        wStart.setUTCDate(wStart.getUTCDate()+7);
      }
      return weeks;
    };
    const inRange = (d, a, b) => d >= a && d <= b;

    // format YYYY-MM-DD in chosen tz (or local)
    const ymdInTz = (d, tz) => new Intl.DateTimeFormat('en-CA', {
      timeZone: tz === 'local' ? undefined : tz, year:'numeric', month:'2-digit', day:'2-digit'
    }).format(d);

    // minutes since start of day in chosen tz
    const minutesInDay = (d, tz) => {
      const parts = new Intl.DateTimeFormat('en-GB', {
        timeZone: tz === 'local' ? undefined : tz, hour:'2-digit', minute:'2-digit', hour12:false
      }).formatToParts(d);
      let hh=0, mm=0;
      for (const p of parts) {
        if (p.type === 'hour') hh = parseInt(p.value,10);
        if (p.type === 'minute') mm = parseInt(p.value,10);
      }
      return hh*60 + mm;
    };

    // ==== FETCH MONTH ====
    async function fetchMonthRange(rangeStartISO, rangeEndISO) {
      const { schedules = [] } = await rcFetch(`/station/${STATION_ID}/schedule?startDate=${encodeURIComponent(rangeStartISO)}&endDate=${encodeURIComponent(rangeEndISO)}`);
      return schedules.map(s => ({
        start: s.startDateUtc || s.startDate || s.startAt || s.start,
        end:   s.endDateUtc   || s.endDate   || s.endAt   || s.end,
        title: s.title || s.content?.title || s.content?.name || "Untitled show",
        host:  (Array.isArray(s.content?.presenters) ? s.content.presenters.map(p => p.name).filter(Boolean).join(", ") : "")
               || s.metadata?.artist || s.dj || "",
        art:   s.metadata?.artwork?.default || s.metadata?.artwork?.original || s.image || "",
        raw: s
      })).filter(s => s.start && s.end);
    }

    // ==== COLOURS ====
    const ORDER_CLASSES = ['tone-1','tone-2','tone-3','tone-4','tone-5','tone-6','tone-7','tone-8'];
    const isArchive = (s) => {
      const blob = `${s.title||''} ${s.host||''}`.toLowerCase();
      return blob.includes('archive') || blob.includes('archives');
    };

    // ==== RENDER ====
    function fmtTime(d, tz) {
      if (tz === "local") return new Intl.DateTimeFormat(undefined,{hour:"2-digit",minute:"2-digit"}).format(d);
      return new Intl.DateTimeFormat(undefined,{hour:"2-digit",minute:"2-digit", timeZone: tz}).format(d);
    }
    function escapeHtml(str){return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));}

    function buildTimeRuler() {
      const col = document.createElement('div');
      col.className = 'time-col';
      for (let h=0; h<24; h++) {
        const label = document.createElement('div');
        label.className = 'hour-label';
        label.style.top = `calc(${h} * var(--hourH))`;
        label.textContent = String(h).padStart(2,'0') + ':00';
        col.appendChild(label);
      }
      return col;
    }

    function reorderWeeksWithCurrentFirst(weeks) {
      const today = new Date();
      const idx = weeks.findIndex(w => inRange(today, w.start, w.end));
      if (idx === -1) return weeks;
      return [weeks[idx], ...weeks.slice(idx+1), ...weeks.slice(0, idx)];
    }

    function renderMonth(date, shows, tz) {
      const mount = document.getElementById("weeksStack");
      mount.innerHTML = "";
      document.getElementById("monthTitle").textContent = fmtMonth(date);

      // Bucket by day in the chosen tz and sort by start
      const buckets = new Map();
      shows.forEach(s => {
        const st = new Date(s.start);
        const key = ymdInTz(st, tz);
        if (!buckets.has(key)) buckets.set(key, []);
        buckets.get(key).push(s);
      });
      for (const [, arr] of buckets) arr.sort((a,b)=> new Date(a.start) - new Date(b.start));

      let weeks = splitMonthIntoWeeks(date);
      weeks = reorderWeeksWithCurrentFirst(weeks);  // current week appears first

      weeks.forEach(({start}) => {
        const weekEl = document.createElement("section");
        weekEl.className = "week-grid";

        // Time ruler
        weekEl.appendChild(buildTimeRuler());

        // Build each day
        const d = new Date(start);
        for (let i=0;i<7;i++) {
          const dayCol = document.createElement("div");
          dayCol.className = "day-col";
          const head = document.createElement("div");
          head.className = "day-head";
          const dow = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"][(d.getUTCDay()+6)%7];
          head.innerHTML = `<div class="dow">${dow}</div><div class="date">${d.getUTCDate()} ${d.toLocaleString(undefined,{month:'short'})}</div>`;
          const body = document.createElement("div");
          body.className = "day-body";

          const keyTz = ymdInTz(new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())), tz);
          const todays = buckets.get(keyTz) || [];

          todays.forEach((s, idx) => {
            const st = new Date(s.start), en = new Date(s.end);
            const startMin = minutesInDay(st, tz);
            let endMin = minutesInDay(en, tz);
            if (endMin <= startMin) endMin = 24*60; // spans midnight -> cap to end of day

            const startQ = Math.floor(startMin / 15);
            const spanQ = Math.max(1, Math.ceil((endMin - startMin) / 15));

            const show = document.createElement('div');
            show.className = "show " + (isArchive(s) ? 'is-archive' : ORDER_CLASSES[idx % ORDER_CLASSES.length]);
            show.style.gridRow = `${startQ + 1} / span ${spanQ}`;

            show.innerHTML = `
              <div class="time">${fmtTime(st, tz)}–${fmtTime(en, tz)}</div>
              <div class="title">${escapeHtml(s.title)}</div>
              ${s.host ? `<div class="host">${escapeHtml(s.host)}</div>` : ""}
            `;
            body.appendChild(show);
          });

          dayCol.append(head, body);
          weekEl.appendChild(dayCol);
          d.setUTCDate(d.getUTCDate()+1);
        }

        mount.appendChild(weekEl);
      });
    }

    // ==== STATE & CONTROLS ====
    let current = new Date();
    let tzMode = "local";

    async function loadMonth() {
      const from = startOfWeek(startOfMonth(current)).toISOString();
      const to   = endOfWeek(endOfMonth(current)).toISOString();
      try {
        const shows = await fetchMonthRange(from, to);
        renderMonth(current, shows, tzMode);
      } catch (e) {
        console.error(e);
        document.getElementById("weeksStack").innerHTML = "<p>Couldn’t load schedule.</p>";
      }
    }

    document.getElementById("prevMonthBtn").addEventListener("click", () => {
      current = new Date(Date.UTC(current.getUTCFullYear(), current.getUTCMonth()-1, 1));
      loadMonth();
      window.scrollTo({ top: 0, behavior: 'instant' });
    });
    document.getElementById("nextMonthBtn").addEventListener("click", () => {
      current = new Date(Date.UTC(current.getUTCFullYear(), current.getUTCMonth()+1, 1));
      loadMonth();
      window.scrollTo({ top: 0, behavior: 'instant' });
    });
    document.getElementById("todayBtn").addEventListener("click", () => {
      current = new Date();
      loadMonth();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    document.getElementById("tzSelect").addEventListener("change", e => { tzMode = e.target.value; loadMonth(); });

    // Boot
    loadMonth();

    // Manual cast fallback (optional)
    document.getElementById('manualCastBtn')?.addEventListener('click', () => {
      const context = cast.framework.CastContext.getInstance();
      context.requestSession().catch(err => console.error('Fallback session error', err));
    });
  </script>
</body>
</html>
