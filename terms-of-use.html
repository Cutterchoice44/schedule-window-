<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cutters Choice Radio — Schedule</title>

  <!-- Site CSS + Fonts -->
  <link rel="stylesheet" href="style.css?v=1754655398070" />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- NAV styling copied from index.html -->
  <style>
    :root {
      --brand-teal: #5A8785;

      /* schedule scale */
      --hourH: 52px;                 /* height per hour */
      --qH: calc(var(--hourH) / 4);  /* 15-min track */
    }

    /* NAV */
    #main-nav{display:flex!important;justify-content:space-between!important;align-items:center!important;width:100%!important;padding:.10rem .65rem!important;margin:0!important;box-sizing:border-box!important;background-color:var(--brand-teal)!important;position:relative!important;z-index:1000!important}
    #main-nav .nav-item{flex:1!important}
    #main-nav .nav-left{text-align:left!important}
    #main-nav .nav-center{text-align:center!important}
    #main-nav .nav-right{display:flex!important;align-items:center!important;justify-content:flex-end!important;flex:1!important}
    #main-nav a.nav-link{color:#fff!important;font-family:'Bebas Neue',sans-serif!important;font-size:2rem!important;text-transform:uppercase!important;text-decoration:none!important;margin:0 .5rem!important}
    #main-nav .social-icon,#main-nav .icon-img{margin-left:.5rem!important;vertical-align:middle!important;width:2rem!important;height:auto!important}
    #manualCastBtn{background:none;border:none;color:#fff;font-size:1.8rem;cursor:pointer;margin-left:.5rem}
    @media (max-width:768px){
      #main-nav{flex-wrap:nowrap!important;padding:.115rem .5rem!important}
      #main-nav .nav-item{text-align:center!important;flex:1!important}
      #main-nav a.nav-link{font-size:1rem!important;margin:0 .25rem!important}
      #main-nav .social-icon,#main-nav .icon-img,#main-nav .nav-onemusic{display:none!important}
    }

    /* PAGE */
    html,body{background:#000;color:#fafafa}
    *{box-sizing:border-box}

    .page-header{display:flex;align-items:center;justify-content:space-between;padding:.5rem .75rem;border-bottom:2px solid #000;background:var(--brand-teal)}
    .page-header h1{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;letter-spacing:.5px;color:#fff;margin:0}
    .utilities{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
    .legend{display:flex;gap:.5rem;align-items:center}
    .chip{width:.9rem;height:.9rem;border-radius:2px;border:1px solid #1f1f1f;display:inline-block}

    .month-controls{display:flex;gap:.5rem;align-items:center;justify-content:space-between;border-bottom:1px solid var(--brand-teal);padding:.75rem .75rem;position:sticky;top:0;background:#000;z-index:20}
    .month-controls .title{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--brand-teal)}
    .ccr-btn{background:var(--brand-teal);color:#fff;border:none;border-radius:6px;padding:.5rem .75rem;cursor:pointer;font-weight:600;letter-spacing:.3px}

    .weeks-stack{display:flex;flex-direction:column;gap:1.25rem;padding:1rem .75rem 2rem}

    /* 8 columns: time ruler + 7 days */
    .week-grid{display:grid;grid-template-columns:64px repeat(7,1fr);gap:6px;border:2px solid var(--brand-teal);border-radius:8px;overflow:hidden;background:#0f0f0f;padding:6px}

    /* Time ruler */
    .time-col{position:relative;height:calc(var(--hourH)*24);border:1px solid #1c1c1c;border-radius:6px;background:repeating-linear-gradient(to bottom,#0b0b0b 0,#0b0b0b calc(var(--hourH) - 1px),#1e1e1e calc(var(--hourH) - 1px),#1e1e1e var(--hourH))}
    .time-col .hour-label{position:absolute;left:6px;font-size:.78rem;color:#a7a7a7;transform:translateY(-50%)}

    /* Day header + body */
    .day-col{display:flex;flex-direction:column}
    .day-head{background:#0d0d0d;border:1px solid #1e1e1e;padding:.45rem .5rem;border-radius:6px;margin-bottom:6px}
    .dow{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:var(--brand-teal)}
    .date{font-size:.85rem;color:#bdbdbd}

    .day-body{display:grid;grid-template-rows:repeat(96,var(--qH));position:relative;height:calc(var(--hourH)*24);border:1px solid #1c1c1c;border-radius:6px;overflow:hidden;background:repeating-linear-gradient(to bottom,#0b0b0b 0,#0b0b0b calc(var(--hourH) - 1px),#1a1a1a calc(var(--hourH) - 1px),#1a1a1a var(--hourH))}

    /* Show block — FULL bright colour */
    .show{
      grid-column:1/-1;margin:2px 4px;
      background:var(--chip,#FBBF24); color:var(--fg,#1b0f00);
      border-radius:10px; padding:.48rem .6rem; overflow:hidden;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.2);
    }
    .show .time{font-size:.78rem;opacity:.95}
    .show .title{font-weight:800;line-height:1.2}
    .show .host{font-size:.85rem;opacity:.92}

    /* Palette (warm tones first so 1st show pops) */
    .tone-1{--chip:#FBBF24;--fg:#1b0f00} /* gold */
    .tone-2{--chip:#FB923C;--fg:#1a0900} /* orange */
    .tone-3{--chip:#EC4899;--fg:#220713} /* pink  */
    .tone-4{--chip:#A78BFA;--fg:#0e0a1a} /* violet */
    .tone-5{--chip:#06B6D4;--fg:#001318} /* cyan */
    .tone-6{--chip:#60A5FA;--fg:#0a1a35} /* light blue */
    .tone-7{--chip:#10B981;--fg:#00150e} /* green */
    .tone-8{--chip:#4ADE80;--fg:#041307} /* light green */

    /* Archives = LIGHTER blue and readable text */
    .is-archive{--chip:#93C5FD;--fg:#0b1f3f}

    @media (max-width:980px){
      .week-grid{grid-template-columns:48px 1fr}
      .day-col{grid-column:2}
      .time-col{grid-column:1}
    }
  </style>

  <!-- Chromecast init (kept) -->
  <script>
    window.__onGCastApiAvailable = isAvailable => {
      if (isAvailable) {
        cast.framework.CastContext.getInstance().setOptions({
          receiverApplicationId: '77E0F81B',
          autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
        });
      }
    };
  </script>
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</head>

<body>
  <!-- NAV -->
  <nav id="main-nav">
    <div class="nav-item nav-left">
      <a href="index.html" class="nav-link">HOME</a>
      <a href="our-story.html" class="nav-link">OUR STORY</a>
    </div>
    <div class="nav-item nav-center">
      <a href="index-ourDJS.html" class="nav-link">OUR DJS</a>
    </div>
    <div class="nav-item nav-right">
      <!-- Removed SCHEDULE (redundant on this page) -->
      <a href="merch.html" class="nav-link">MERCH</a>

      <a href="https://facebook.com/cutterschoiceradio" target="_blank" class="social-icon"><i class="fab fa-facebook-f"></i></a>
      <a href="https://instagram.com/cutterschoiceradio" target="_blank" class="social-icon"><i class="fab fa-instagram"></i></a>

      <img src="/images/alexa-logo.webp" alt="Alexa" class="icon-img" loading="lazy">
      <a href="https://tunein.com/radio/Cutters-Choice-Radio-s344746/" target="_blank"><img src="/images/tunein-logo.png" alt="TuneIn" class="icon-img" loading="lazy"></a>

      <div class="nav-onemusic">
        <a href="https://onemusicnz.com" target="_blank" rel="noopener"><img src="/images/ONEMUSICLOGO.png" alt="We’re licensed to play OneMusic NZ" loading="lazy"></a>
      </div>

      <google-cast-button></google-cast-button>
      <button id="manualCastBtn" title="Cast this stream"><i class="fab fa-chromecast"></i></button>
    </div>
  </nav>

  <header class="page-header">
    <h1>Monthly Schedule</h1>
    <div class="utilities">
      <button class="ccr-btn" id="todayBtn" title="Jump to current week">This Week</button>
      <div class="legend">
        <!-- Warm-first chips -->
        <span class="chip" style="background:#FBBF24"></span>
        <span class="chip" style="background:#FB923C"></span>
        <span class="chip" style="background:#EC4899"></span>
        <span class="chip" style="background:#A78BFA"></span>
        <span class="chip" style="background:#06B6D4"></span>
        <span class="chip" style="background:#60A5FA"></span>
        <span class="chip" style="background:#10B981"></span>
        <span class="chip" style="background:#4ADE80"></span>
        <small style="opacity:.85;">Order of shows each day</small>
        <span class="chip" style="background:#93C5FD;margin-left:.5rem;"></span>
        <small style="opacity:.85;">Archives</small>
      </div>
    </div>
  </header>

  <section class="month-controls">
    <div>
      <button class="ccr-btn" id="prevMonthBtn" aria-label="Previous month">◀</button>
      <button class="ccr-btn" id="nextMonthBtn" aria-label="Next month">▶</button>
    </div>
    <div class="title" id="monthTitle">Loading…</div>
    <div>
      <label style="display:flex;align-items:center;gap:.35rem;">
        <span style="font-size:.9rem;color:#bdbdbd;">Times in</span>
        <select id="tzSelect" class="ccr-btn" style="background:#0a0a0a;border:1px solid #1c1c1c;color:#fff;">
          <option value="local">Your local time</option>
          <option value="Europe/London">UK (Europe/London)</option>
          <option value="UTC">UTC</option>
        </select>
      </label>
    </div>
  </section>

  <main class="weeks-stack" id="weeksStack" aria-live="polite">
    <p style="opacity:.7;">Fetching month…</p>
  </main>

  <footer class="banner">
    <a href="privacy-policy.html">PRIVACY POLICY</a>
    <a href="index.html">Back to Home</a>
  </footer>

  <script>
    /* ===== API (same style as homepage) ===== */
    const API_KEY   = "pk_0b8abc6f834b444f949f727e88a728e0";
    const STATION_ID= "cutters-choice-radio";
    const BASE_URL  = "https://api.radiocult.fm/api";
    const rcFetch   = async (path) => {
      const res = await fetch(BASE_URL + path, { headers: { "x-api-key": API_KEY } });
      if (!res.ok) throw new Error(`Fetch error ${res.status}`);
      return res.json();
    };

    /* ===== Date helpers ===== */
    const pad = n => String(n).padStart(2,"0");
    const fmtMonth = d => new Intl.DateTimeFormat(undefined,{month:"long",year:"numeric"}).format(d);
    const startOfWeek = (date) => { const d=new Date(Date.UTC(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate())); const day=(d.getUTCDay()+6)%7; d.setUTCDate(d.getUTCDate()-day); return d; };
    const endOfWeek = (date) => { const d=new Date(date); d.setUTCDate(d.getUTCDate()+6); d.setUTCHours(23,59,59,999); return d; };
    const startOfMonth = (date) => new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), 1));
    const endOfMonth   = (date) => new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth()+1, 0, 23,59,59,999));
    const inRange = (d,a,b)=> d>=a && d<=b;
    const splitMonthIntoWeeks = (anyDay) => { const weeks=[]; let w=startOfWeek(startOfMonth(anyDay)); const last=endOfWeek(endOfMonth(anyDay)); while(w<=last){weeks.push({start:new Date(w),end:endOfWeek(w)}); w.setUTCDate(w.getUTCDate()+7);} return weeks; };

    // yyyy-mm-dd in chosen tz
    const ymdInTz = (d, tz) => new Intl.DateTimeFormat('en-CA',{
      timeZone: tz==='local'?undefined:tz, year:'numeric',month:'2-digit',day:'2-digit'
    }).format(d);

    // minutes since day start in tz
    const minutesInDay = (d, tz) => {
      const parts = new Intl.DateTimeFormat('en-GB',{ timeZone: tz==='local'?undefined:tz, hour:'2-digit', minute:'2-digit', hour12:false }).formatToParts(d);
      let hh=0,mm=0; for(const p of parts){ if(p.type==='hour') hh=parseInt(p.value,10); if(p.type==='minute') mm=parseInt(p.value,10); }
      return hh*60+mm;
    };

    /* ===== Fetch schedule ===== */
    async function fetchMonthRange(rangeStartISO, rangeEndISO) {
      const { schedules = [] } = await rcFetch(`/station/${STATION_ID}/schedule?startDate=${encodeURIComponent(rangeStartISO)}&endDate=${encodeURIComponent(rangeEndISO)}`);
      return schedules.map(s => ({
        start: s.startDateUtc || s.startDate || s.startAt || s.start,
        end:   s.endDateUtc   || s.endDate   || s.endAt   || s.end,
        title: s.title || s.content?.title || s.content?.name || "Untitled show",
        host:  (Array.isArray(s.content?.presenters) ? s.content.presenters.map(p => p.name).filter(Boolean).join(", ") : "")
               || s.metadata?.artist || s.dj || "",
        raw: s
      })).filter(s => s.start && s.end);
    }

    /* ===== Colour rules ===== */
    const ORDER_CLASSES = ['tone-1','tone-2','tone-3','tone-4','tone-5','tone-6','tone-7','tone-8'];
    const isArchive = (s) => {
      const blob = `${s.title||''} ${s.host||''}`.toLowerCase();
      return blob.includes('archive') || blob.includes('archives');
    };

    /* ===== Split overnight and fill gaps with Archives ===== */
    const incYMD = (s) => { const [y,m,d]=s.split('-').map(Number); const dt=new Date(Date.UTC(y,m-1,d)); dt.setUTCDate(dt.getUTCDate()+1); return `${dt.getUTCFullYear()}-${pad(dt.getUTCMonth()+1)}-${pad(dt.getUTCDate())}`; };

    function splitShowsIntoDailySegments(shows, tz) {
      const map = new Map(); // key yyyy-mm-dd -> [{segStartMin, segEndMin, ...}]
      for (const s of shows) {
        const st = new Date(s.start), en = new Date(s.end);
        const kStart = ymdInTz(st, tz), kEnd = ymdInTz(en, tz);
        let key = kStart;
        while (true) {
          const segStartMin = (key===kStart) ? minutesInDay(st, tz) : 0;
          const segEndMin   = (key===kEnd)   ? minutesInDay(en, tz) : 24*60;
          const seg = { ...s, segStartMin, segEndMin: Math.max(segStartMin+15, segEndMin), archive: isArchive(s) };
          if (!map.has(key)) map.set(key, []);
          map.get(key).push(seg);
          if (key===kEnd) break;
          key = incYMD(key);
        }
      }
      // sort and fill gaps with archive segments
      for (const [key, arr] of map) {
        arr.sort((a,b)=> a.segStartMin - b.segStartMin);
        const filled = [];
        let cur = 0;
        for (const seg of arr) {
          if (seg.segStartMin > cur) {
            filled.push({
              title: "Choice Cuts Archives",
              host: "",
              archive: true,
              segStartMin: cur,
              segEndMin: seg.segStartMin
            });
          }
          filled.push(seg);
          cur = Math.max(cur, seg.segEndMin);
        }
        if (cur < 24*60) {
          filled.push({ title: "Choice Cuts Archives", host: "", archive: true, segStartMin: cur, segEndMin: 24*60 });
        }
        map.set(key, filled);
      }
      return map;
    }

    /* ===== Render ===== */
    const fmtHM = (min) => {
      let h = Math.floor(min/60), m = min % 60;
      const ampm = h >= 12 ? 'pm':'am';
      let hh = ((h + 11) % 12) + 1;
      return `${String(hh).padStart(2,'0')}:${String(m).padStart(2,'0')} ${ampm}`;
    };

    function buildTimeRuler(){
      const col=document.createElement('div'); col.className='time-col';
      for(let h=0;h<24;h++){ const lab=document.createElement('div'); lab.className='hour-label'; lab.style.top=`calc(${h} * var(--hourH))`; lab.textContent=String(h).padStart(2,'0')+':00'; col.appendChild(lab); }
      return col;
    }

    const reorderWeeksWithCurrentFirst = (weeks) => {
      const today = new Date();
      const i = weeks.findIndex(w => inRange(today, w.start, w.end));
      return i===-1 ? weeks : [weeks[i], ...weeks.slice(i+1), ...weeks.slice(0,i)];
    };

    function renderMonth(date, shows, tz){
      const mount=document.getElementById('weeksStack'); mount.innerHTML='';
      document.getElementById('monthTitle').textContent = fmtMonth(date);

      const buckets = splitShowsIntoDailySegments(shows, tz);

      let weeks = splitMonthIntoWeeks(date);
      weeks = reorderWeeksWithCurrentFirst(weeks);

      weeks.forEach(({start})=>{
        const weekEl=document.createElement('section'); weekEl.className='week-grid';
        weekEl.appendChild(buildTimeRuler());

        const d=new Date(start);
        for(let i=0;i<7;i++){
          const dayCol=document.createElement('div'); dayCol.className='day-col';
          const head=document.createElement('div'); head.className='day-head';
          const dow=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][(d.getUTCDay()+6)%7];
          head.innerHTML=`<div class="dow">${dow}</div><div class="date">${d.getUTCDate()} ${d.toLocaleString(undefined,{month:'short'})}</div>`;
          const body=document.createElement('div'); body.className='day-body';

          const dayKey = ymdInTz(new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())), tz);
          const segments = buckets.get(dayKey) || [];

          // colour order index advances only on non-archives
          let orderIndex = 0;

          segments.forEach(seg=>{
            const startQ = Math.floor(seg.segStartMin/15);
            const spanQ  = Math.max(1, Math.ceil((seg.segEndMin - seg.segStartMin)/15));
            const show=document.createElement('div');
            show.className='show ' + (seg.archive ? 'is-archive' : ORDER_CLASSES[(orderIndex++) % ORDER_CLASSES.length]);
            show.style.gridRow = `${startQ+1} / span ${spanQ}`;

            // times from the segment minutes (correct for split/overnight & fillers)
            show.innerHTML = `
              <div class="time">${fmtHM(seg.segStartMin)}–${fmtHM(seg.segEndMin)}</div>
              <div class="title">${String(seg.title).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
              ${seg.host ? `<div class="host">${String(seg.host).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>` : ""}
            `;
            if (seg.archive) { orderIndex--; } // archives don't consume colour slots
            body.appendChild(show);
          });

          dayCol.append(head, body);
          weekEl.appendChild(dayCol);
          d.setUTCDate(d.getUTCDate()+1);
        }

        mount.appendChild(weekEl);
      });
    }

    /* ===== State & controls ===== */
    let current = new Date();
    let tzMode = "local";

    async function loadMonth(){
      const from=startOfWeek(startOfMonth(current)).toISOString();
      const to=endOfWeek(endOfMonth(current)).toISOString();
      try{
        const shows=await fetchMonthRange(from,to);
        renderMonth(current,shows,tzMode);
      }catch(e){
        console.error(e);
        document.getElementById('weeksStack').innerHTML="<p>Couldn’t load schedule.</p>";
      }
    }

    document.getElementById('prevMonthBtn').addEventListener('click',()=>{ current=new Date(Date.UTC(current.getUTCFullYear(),current.getUTCMonth()-1,1)); loadMonth(); window.scrollTo({top:0}); });
    document.getElementById('nextMonthBtn').addEventListener('click',()=>{ current=new Date(Date.UTC(current.getUTCFullYear(),current.getUTCMonth()+1,1)); loadMonth(); window.scrollTo({top:0}); });
    document.getElementById('todayBtn').addEventListener('click',()=>{ current=new Date(); loadMonth(); window.scrollTo({top:0,behavior:'smooth'}); });
    document.getElementById('tzSelect').addEventListener('change',e=>{ tzMode=e.target.value; loadMonth(); });

    loadMonth();

    // manual cast fallback
    document.getElementById('manualCastBtn')?.addEventListener('click',()=>{
      const context = cast.framework.CastContext.getInstance();
      context.requestSession().catch(err=>console.error('Fallback session error',err));
    });
  </script>
</body>
</html>
